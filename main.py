import matplotlib.pyplot as plt
from tqdm import tqdm
import numpy as np
import argparse
import requests

from dictionaries import *
from kmeans import KMeans

# arguments
parser = argparse.ArgumentParser()
parser.add_argument('--cve', type=int, help='Number of CVEs to fetch.')
args = parser.parse_args()
final_index = args.cve

keys, vectors, cve_name, description = [], [], [], []
for i in tqdm(range(0, final_index, 20)):

	url = "https://services.nvd.nist.gov/rest/json/cves/1.0?cpeMatchString=cpe:2.3:o:microsoft:windows_10&startIndex={}&resultsPerPage=20".format(i)
	r = requests.get(url)
	data = r.json()

	cves = data['result']['CVE_Items']
	for cve in cves:

		#MetricsV3
		keys.append(attack_vector[cve['impact']['baseMetricV3']['cvssV3']['attackVector']])
		keys.append(attack_complexity[cve['impact']['baseMetricV3']['cvssV3']['attackComplexity']])
		keys.append(privileges_required[cve['impact']['baseMetricV3']['cvssV3']['privilegesRequired']])
		keys.append(user_interaction[cve['impact']['baseMetricV3']['cvssV3']['userInteraction']])
		keys.append(scope[cve['impact']['baseMetricV3']['cvssV3']['scope']])
		keys.append(confidentiality_impactv3[cve['impact']['baseMetricV3']['cvssV3']['confidentialityImpact']])
		keys.append(integrity_impactv3[cve['impact']['baseMetricV3']['cvssV3']['integrityImpact']])
		keys.append(availability_impactv3[cve['impact']['baseMetricV3']['cvssV3']['availabilityImpact']])
		keys.append(cve['impact']['baseMetricV3']['cvssV3']['baseScore'])
		keys.append(base_severity[cve['impact']['baseMetricV3']['cvssV3']['baseSeverity']])
		keys.append(cve['impact']['baseMetricV3']['exploitabilityScore'])
		keys.append(cve['impact']['baseMetricV3']['impactScore'])

		#MetricsV2
		keys.append(access_vector[cve['impact']['baseMetricV2']['cvssV2']['accessVector']])
		keys.append(access_complexity[cve['impact']['baseMetricV2']['cvssV2']['accessComplexity']])
		keys.append(authentication[cve['impact']['baseMetricV2']['cvssV2']['authentication']])
		keys.append(confidentiality_impact[cve['impact']['baseMetricV2']['cvssV2']['confidentialityImpact']])
		keys.append(integrity_impact[cve['impact']['baseMetricV2']['cvssV2']['integrityImpact']])
		keys.append(availability_impact[cve['impact']['baseMetricV2']['cvssV2']['availabilityImpact']])
		keys.append(cve['impact']['baseMetricV2']['cvssV2']['baseScore'])
		keys.append(severity[cve['impact']['baseMetricV2']['severity']])
		keys.append(cve['impact']['baseMetricV2']['exploitabilityScore'])
		keys.append(cve['impact']['baseMetricV2']['impactScore'])
		keys.append(cve['impact']['baseMetricV2']['impactScore'])

		try:
			keys.append(boolean[cve['impact']['baseMetricV2']['acInsufInfo']])
		except KeyError as e:
			keys.append(2) # False
		try:
			keys.append(boolean[cve['impact']['baseMetricV2']['obtainAllPrivilege']])
		except KeyError as e:
			keys.append(2) 
		try:
			keys.append(boolean[cve['impact']['baseMetricV2']['obtainUserPrivilege']])
		except KeyError as e:
			keys.append(2) 
		try:	
			keys.append(boolean[cve['impact']['baseMetricV2']['obtainOtherPrivilege']])
		except KeyError as e:
			keys.append(2) 
		try:
			keys.append(boolean[cve['impact']['baseMetricV2']['userInteractionRequired']])		
		except KeyError as e:
			keys.append(2) 

		#Extra information
		cve_name.append(cve['cve']['CVE_data_meta']['ID'])
		description.append(cve['cve']['description']['description_data'][0]['value'])
		vectors.append(np.array(keys))
		keys = []

X = np.array(vectors)
print('Collected {} CVEs.'.format(X.shape[0]))

colors = ['red', 'black', 'blue', 'green', 'pink', 'purple', 'grey']

model = KMeans(k=5)
X = model.prepare(X)
model.fit(X)

i = 0
for cluster in model.clusters:
	color = colors[cluster]
	for featureset in model.clusters[cluster]:
		plt.scatter(featureset[0], featureset[1], marker="o", color=color, s=150, linewidths=5, zorder=1)
		plt.annotate(cve_name[i], (featureset[0], featureset[1]), textcoords="offset points", ha='center', xytext=(0,10))
		i += 1
	for centroid in model.centroids:
		plt.scatter(model.centroids[centroid][0], model.centroids[centroid][1],marker="x", color="yellow", s=150, linewidths=5, zorder=2)

plt.show()
